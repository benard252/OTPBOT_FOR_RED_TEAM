<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéôÔ∏è OTP Voice App - Educational Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        accent: '#F59E0B',
                        danger: '#EF4444'
                    }
                }
            }
        }
    </script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-online { background-color: #10B981; }
        .status-offline { background-color: #EF4444; }
        .status-warning { background-color: #F59E0B; }
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="text-3xl">üéôÔ∏è</div>
                    <div>
                        <h1 class="text-2xl font-bold">OTP Voice App</h1>
                        <p class="text-blue-100 text-sm">Educational Platform</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-right">
                        <div class="text-sm text-blue-100">Status</div>
                        <div id="app-status" class="font-semibold">
                            <span class="status-indicator status-online pulse-animation"></span>
                            Online
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Warning Banner -->
    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
        <div class="container mx-auto px-6">
            <div class="flex items-center">
                <div class="text-yellow-400 text-xl mr-3">‚ö†Ô∏è</div>
                <div>
                    <p class="text-yellow-800 font-semibold">Educational Use Only</p>
                    <p class="text-yellow-700 text-sm">This application is designed for learning and testing purposes. Do not use for actual authentication systems.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-6 py-8">
        <!-- Configuration Panel -->
        <div class="mb-8">
            <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <span class="text-2xl mr-2">‚öôÔ∏è</span>
                    API Configuration
                </h2>
                
                <!-- Configuration Tabs -->
                <div class="border-b border-gray-200 mb-6">
                    <nav class="-mb-px flex space-x-8">
                        <button onclick="showConfigTab('twilio')" id="tab-twilio" class="config-tab py-2 px-1 border-b-2 font-medium text-sm border-primary text-primary">
                            üìû Twilio
                        </button>
                        <button onclick="showConfigTab('elevenlabs')" id="tab-elevenlabs" class="config-tab py-2 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                            üéôÔ∏è ElevenLabs
                        </button>
                        <button onclick="showConfigTab('telegram')" id="tab-telegram" class="config-tab py-2 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                            ü§ñ Telegram
                        </button>
                        <button onclick="showConfigTab('ngrok')" id="tab-ngrok" class="config-tab py-2 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                            üåê Ngrok
                        </button>
                    </nav>
                </div>

                <!-- Configuration Forms -->
                <div id="config-content">
                    <!-- Twilio Config -->
                    <div id="config-twilio" class="config-panel">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Account SID</label>
                                <input type="text" id="twilio-account-sid" placeholder="ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Auth Token</label>
                                <input type="password" id="twilio-auth-token" placeholder="Your auth token" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
                                <input type="text" id="twilio-phone-number" placeholder="+1234567890" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                            </div>
                            <div class="flex items-end">
                                <div class="flex space-x-2 w-full">
                                    <button onclick="saveConfig('twilio')" class="flex-1 bg-primary text-white px-4 py-2 rounded-md hover:bg-blue-600 transition-colors">
                                        üíæ Save Twilio Config
                                    </button>
                                    <button onclick="testConfig('twilio')" class="bg-secondary text-white px-4 py-2 rounded-md hover:bg-green-600 transition-colors">
                                        üß™ Test
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div id="twilio-status" class="mt-4"></div>
                    </div>

                    <!-- ElevenLabs Config -->
                    <div id="config-elevenlabs" class="config-panel hidden">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">API Key</label>
                                <input type="password" id="elevenlabs-api-key" placeholder="sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Default Voice</label>
                                <select id="elevenlabs-default-voice" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                                    <option value="Rachel">Rachel (Recommended)</option>
                                    <option value="Sarah">Sarah</option>
                                    <option value="Emily">Emily</option>
                                    <option value="Adam">Adam</option>
                                    <option value="Paul">Paul</option>
                                    <option value="Drew">Drew</option>
                                    <option value="Antoni">Antoni</option>
                                </select>
                            </div>
                            <div class="md:col-span-2">
                                <div class="flex space-x-2">
                                    <button onclick="saveConfig('elevenlabs')" class="flex-1 bg-primary text-white px-4 py-2 rounded-md hover:bg-blue-600 transition-colors">
                                        üíæ Save ElevenLabs Config
                                    </button>
                                    <button onclick="testConfig('elevenlabs')" class="bg-secondary text-white px-4 py-2 rounded-md hover:bg-green-600 transition-colors">
                                        üß™ Test
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div id="elevenlabs-status" class="mt-4"></div>
                    </div>

                    <!-- Telegram Config -->
                    <div id="config-telegram" class="config-panel hidden">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Bot Token</label>
                                <input type="password" id="telegram-bot-token" placeholder="1234567890:ABCdefGHIjklMNOpqrsTUVwxyz" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Public Chat ID (Optional)</label>
                                <input type="text" id="telegram-public-chat" placeholder="-1001234567890" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                            </div>
                            <div class="md:col-span-2">
                                <div class="flex space-x-2">
                                    <button onclick="saveConfig('telegram')" class="flex-1 bg-primary text-white px-4 py-2 rounded-md hover:bg-blue-600 transition-colors">
                                        üíæ Save Telegram Config
                                    </button>
                                    <button onclick="testConfig('telegram')" class="bg-secondary text-white px-4 py-2 rounded-md hover:bg-green-600 transition-colors">
                                        üß™ Test
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div id="telegram-status" class="mt-4"></div>
                    </div>

                    <!-- Ngrok Config -->
                    <div id="config-ngrok" class="config-panel hidden">
                        <div class="grid grid-cols-1 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ngrok URL</label>
                                <input type="url" id="ngrok-url" placeholder="https://abc123.ngrok-free.app" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                                <p class="text-sm text-gray-500 mt-1">Run 'ngrok http 5000' in terminal and paste the URL here</p>
                            </div>
                            <div>
                                <div class="flex space-x-2">
                                    <button onclick="saveConfig('ngrok')" class="flex-1 bg-primary text-white px-4 py-2 rounded-md hover:bg-blue-600 transition-colors">
                                        üíæ Save Ngrok Config
                                    </button>
                                    <button onclick="testConfig('ngrok')" class="bg-secondary text-white px-4 py-2 rounded-md hover:bg-green-600 transition-colors">
                                        üß™ Test
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div id="ngrok-status" class="mt-4"></div>
                    </div>
                </div>

                <!-- Validate All Button -->
                <div class="mt-6 pt-6 border-t border-gray-200">
                    <button onclick="validateAllConfigs()" class="w-full bg-accent text-white px-6 py-3 rounded-md hover:bg-yellow-600 transition-colors font-semibold">
                        ‚úÖ Validate All Configurations
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Dashboard -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Voice OTP Generation -->
            <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <span class="text-2xl mr-2">üìû</span>
                    Voice OTP Generation
                </h2>
                
                <form id="voice-otp-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
                        <input type="tel" id="voice-phone" placeholder="+1234567890" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Script Type</label>
                        <select id="voice-script" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                            <option value="default">Default Verification</option>
                            <option value="microsoft">Microsoft Security</option>
                            <option value="bank">Banking Security</option>
                            <option value="google">Google Security</option>
                            <option value="otp france">French OTP</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Voice</label>
                        <select id="voice-voice" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                            <option value="Rachel">Rachel (Professional)</option>
                            <option value="Sarah">Sarah (French Accent)</option>
                            <option value="Emily">Emily (Warm)</option>
                            <option value="Adam">Adam (Male)</option>
                            <option value="Paul">Paul (Authoritative)</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="w-full bg-primary text-white px-6 py-3 rounded-md hover:bg-blue-600 transition-colors font-semibold">
                        üéôÔ∏è Generate Voice OTP
                    </button>
                </form>
                
                <div id="voice-result" class="mt-4"></div>
            </div>

            <!-- SMS OTP Backup -->
            <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <span class="text-2xl mr-2">üì±</span>
                    SMS OTP Backup
                </h2>
                
                <form id="sms-otp-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
                        <input type="tel" id="sms-phone" placeholder="+1234567890" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Message Type</label>
                        <select id="sms-script" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                            <option value="default">Standard SMS</option>
                            <option value="bank">Banking SMS</option>
                            <option value="microsoft">Microsoft SMS</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="w-full bg-secondary text-white px-6 py-3 rounded-md hover:bg-green-600 transition-colors font-semibold">
                        üì± Send SMS OTP
                    </button>
                </form>
                
                <div id="sms-result" class="mt-4"></div>
            </div>
        </div>

        <!-- Live Call Control Dashboard -->
        <div class="mt-8">
            <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <span class="text-2xl mr-2">üìû</span>
                    Live Call Control Dashboard
                    <span class="ml-auto text-sm text-gray-500">Auto-refresh: 3s</span>
                </h2>
                
                <div id="active-calls" class="space-y-4">
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-2">üìû</div>
                        <p>No active calls</p>
                        <p class="text-sm">Active calls will appear here in real-time</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Service Status -->
        <div class="mt-8">
            <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <span class="text-2xl mr-2">üìä</span>
                    Service Status
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4" id="service-status">
                    <!-- Status cards will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8 mt-12">
        <div class="container mx-auto px-6 text-center">
            <div class="text-2xl mb-2">üéì</div>
            <p class="text-lg font-semibold mb-2">Educational Use Only</p>
            <p class="text-gray-300 text-sm">This application is designed for learning and testing purposes.</p>
            <p class="text-gray-400 text-xs mt-4">¬© 2025 OTP Voice App - Educational Platform</p>
        </div>
    </footer>

    <script>
        // Global variables
        let configData = {};
        let activeCallsInterval;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadConfiguration();
            loadServiceStatus();
            setupEventListeners();
            startActiveCallsMonitoring();
        });

        // Configuration Management
        function showConfigTab(service) {
            // Hide all panels
            document.querySelectorAll('.config-panel').forEach(panel => {
                panel.classList.add('hidden');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.config-tab').forEach(tab => {
                tab.classList.remove('border-primary', 'text-primary');
                tab.classList.add('border-transparent', 'text-gray-500');
            });
            
            // Show selected panel
            document.getElementById(`config-${service}`).classList.remove('hidden');
            
            // Activate selected tab
            const activeTab = document.getElementById(`tab-${service}`);
            activeTab.classList.add('border-primary', 'text-primary');
            activeTab.classList.remove('border-transparent', 'text-gray-500');
        }

        async function loadConfiguration() {
            try {
                const response = await fetch('/api/config');
                const data = await response.json();
                
                if (data.success) {
                    configData = data.configuration;
                    populateConfigurationForms();
                    updateConfigurationStatus();
                }
            } catch (error) {
                console.error('Error loading configuration:', error);
            }
        }

        function populateConfigurationForms() {
            // Populate Twilio form
            if (configData.twilio) {
                if (configData.twilio.account_sid && !configData.twilio.account_sid.includes('...')) {
                    document.getElementById('twilio-account-sid').value = configData.twilio.account_sid;
                }
                if (configData.twilio.phone_number) {
                    document.getElementById('twilio-phone-number').value = configData.twilio.phone_number;
                }
            }

            // Populate ElevenLabs form
            if (configData.elevenlabs && configData.elevenlabs.default_voice) {
                document.getElementById('elevenlabs-default-voice').value = configData.elevenlabs.default_voice;
            }

            // Populate Telegram form
            if (configData.telegram && configData.telegram.public_chat) {
                document.getElementById('telegram-public-chat').value = configData.telegram.public_chat;
            }

            // Populate Ngrok form
            if (configData.ngrok && configData.ngrok.url) {
                document.getElementById('ngrok-url').value = configData.ngrok.url;
            }
        }

        function updateConfigurationStatus() {
            // Update tab indicators based on configuration status
            const services = ['twilio', 'elevenlabs', 'telegram', 'ngrok'];
            
            services.forEach(service => {
                const tab = document.getElementById(`tab-${service}`);
                const isConfigured = configData[service] && configData[service].configured;
                
                if (isConfigured) {
                    tab.innerHTML = tab.innerHTML.replace('‚ùå', '‚úÖ').replace('‚ö†Ô∏è', '‚úÖ');
                    if (!tab.innerHTML.includes('‚úÖ')) {
                        tab.innerHTML += ' ‚úÖ';
                    }
                } else {
                    tab.innerHTML = tab.innerHTML.replace('‚úÖ', '‚ùå').replace('‚ö†Ô∏è', '‚ùå');
                    if (!tab.innerHTML.includes('‚ùå')) {
                        tab.innerHTML += ' ‚ùå';
                    }
                }
            });
        }

        async function saveConfig(service) {
            const settings = {};
            
            if (service === 'twilio') {
                settings.account_sid = document.getElementById('twilio-account-sid').value;
                settings.auth_token = document.getElementById('twilio-auth-token').value;
                settings.phone_number = document.getElementById('twilio-phone-number').value;
            } else if (service === 'elevenlabs') {
                settings.api_key = document.getElementById('elevenlabs-api-key').value;
                settings.default_voice = document.getElementById('elevenlabs-default-voice').value;
            } else if (service === 'telegram') {
                settings.bot_token = document.getElementById('telegram-bot-token').value;
                settings.public_chat = document.getElementById('telegram-public-chat').value;
            } else if (service === 'ngrok') {
                settings.url = document.getElementById('ngrok-url').value;
            }

            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        service: service,
                        settings: settings
                    })
                });

                const result = await response.json();
                const statusDiv = document.getElementById(`${service}-status`);

                if (result.success) {
                    statusDiv.innerHTML = `
                        <div class="bg-green-50 border border-green-200 rounded-md p-3">
                            <div class="flex items-center">
                                <span class="text-green-400 text-lg mr-2">‚úÖ</span>
                                <span class="text-green-800 font-medium">${result.message}</span>
                            </div>
                        </div>
                    `;
                    
                    // Reload configuration
                    setTimeout(() => {
                        loadConfiguration();
                        loadServiceStatus();
                    }, 1000);
                } else {
                    statusDiv.innerHTML = `
                        <div class="bg-red-50 border border-red-200 rounded-md p-3">
                            <div class="flex items-center">
                                <span class="text-red-400 text-lg mr-2">‚ùå</span>
                                <span class="text-red-800 font-medium">Error: ${result.error}</span>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error saving configuration:', error);
                const statusDiv = document.getElementById(`${service}-status`);
                statusDiv.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-md p-3">
                        <div class="flex items-center">
                            <span class="text-red-400 text-lg mr-2">‚ùå</span>
                            <span class="text-red-800 font-medium">Network error occurred</span>
                        </div>
                    </div>
                `;
            }
        }

        async function testConfig(service) {
            try {
                const response = await fetch(`/api/config/test/${service}`, {
                    method: 'POST'
                });

                const result = await response.json();
                const statusDiv = document.getElementById(`${service}-status`);

                if (result.success) {
                    statusDiv.innerHTML = `
                        <div class="bg-green-50 border border-green-200 rounded-md p-3">
                            <div class="flex items-center">
                                <span class="text-green-400 text-lg mr-2">‚úÖ</span>
                                <span class="text-green-800 font-medium">${result.message}</span>
                            </div>
                        </div>
                    `;
                } else {
                    statusDiv.innerHTML = `
                        <div class="bg-red-50 border border-red-200 rounded-md p-3">
                            <div class="flex items-center">
                                <span class="text-red-400 text-lg mr-2">‚ùå</span>
                                <span class="text-red-800 font-medium">Test failed: ${result.error}</span>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error testing configuration:', error);
            }
        }

        async function validateAllConfigs() {
            const services = ['twilio', 'elevenlabs', 'telegram', 'ngrok'];
            
            for (const service of services) {
                await testConfig(service);
                await new Promise(resolve => setTimeout(resolve, 500)); // Small delay between tests
            }
        }

        // Event Listeners
        function setupEventListeners() {
            // Voice OTP Form
            document.getElementById('voice-otp-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const phone = document.getElementById('voice-phone').value;
                const script = document.getElementById('voice-script').value;
                const voice = document.getElementById('voice-voice').value;
                
                const resultDiv = document.getElementById('voice-result');
                resultDiv.innerHTML = '<div class="text-blue-600">üîÑ Processing voice OTP request...</div>';
                
                try {
                    const response = await fetch('/api/otp/voice', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            phone_number: phone,
                            script_name: script,
                            user_id: `web_user_${Date.now()}`
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        resultDiv.innerHTML = `
                            <div class="bg-green-50 border border-green-200 rounded-md p-4">
                                <div class="flex items-center mb-2">
                                    <span class="text-green-400 text-lg mr-2">‚úÖ</span>
                                    <span class="text-green-800 font-medium">Voice OTP call initiated successfully!</span>
                                </div>
                                <div class="text-sm text-green-700">
                                    <p><strong>Phone:</strong> ${result.phone_number}</p>
                                    <p><strong>OTP Code:</strong> ${result.otp_code}</p>
                                    <p><strong>Call SID:</strong> ${result.call_sid}</p>
                                    <p><strong>Script:</strong> ${result.script_name}</p>
                                </div>
                            </div>
                        `;
                    } else {
                        resultDiv.innerHTML = `
                            <div class="bg-red-50 border border-red-200 rounded-md p-4">
                                <div class="flex items-center">
                                    <span class="text-red-400 text-lg mr-2">‚ùå</span>
                                    <span class="text-red-800 font-medium">Error: ${result.error}</span>
                                </div>
                            </div>
                        `;
                    }
                } catch (error) {
                    resultDiv.innerHTML = `
                        <div class="bg-red-50 border border-red-200 rounded-md p-4">
                            <div class="flex items-center">
                                <span class="text-red-400 text-lg mr-2">‚ùå</span>
                                <span class="text-red-800 font-medium">Network error occurred</span>
                            </div>
                        </div>
                    `;
                }
            });

            // SMS OTP Form
            document.getElementById('sms-otp-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const phone = document.getElementById('sms-phone').value;
                const script = document.getElementById('sms-script').value;
                
                const resultDiv = document.getElementById('sms-result');
                resultDiv.innerHTML = '<div class="text-blue-600">üîÑ Sending SMS OTP...</div>';
                
                try {
                    const response = await fetch('/api/otp/sms', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            phone_number: phone,
                            script_name: script,
                            user_id: `web_user_${Date.now()}`
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        resultDiv.innerHTML = `
                            <div class="bg-green-50 border border-green-200 rounded-md p-4">
                                <div class="flex items-center mb-2">
                                    <span class="text-green-400 text-lg mr-2">‚úÖ</span>
                                    <span class="text-green-800 font-medium">SMS OTP sent successfully!</span>
                                </div>
                                <div class="text-sm text-green-700">
                                    <p><strong>Phone:</strong> ${result.phone_number}</p>
                                    <p><strong>OTP Code:</strong> ${result.otp_code}</p>
                                    <p><strong>Message SID:</strong> ${result.message_sid}</p>
                                </div>
                            </div>
                        `;
                    } else {
                        resultDiv.innerHTML = `
                            <div class="bg-red-50 border border-red-200 rounded-md p-4">
                                <div class="flex items-center">
                                    <span class="text-red-400 text-lg mr-2">‚ùå</span>
                                    <span class="text-red-800 font-medium">Error: ${result.error}</span>
                                </div>
                            </div>
                        `;
                    }
                } catch (error) {
                    resultDiv.innerHTML = `
                        <div class="bg-red-50 border border-red-200 rounded-md p-4">
                            <div class="flex items-center">
                                <span class="text-red-400 text-lg mr-2">‚ùå</span>
                                <span class="text-red-800 font-medium">Network error occurred</span>
                            </div>
                        </div>
                    `;
                }
            });
        }

        // Service Status
        async function loadServiceStatus() {
            try {
                const [healthResponse, voiceResponse, telegramResponse] = await Promise.all([
                    fetch('/health'),
                    fetch('/voice/status'),
                    fetch('/telegram/status')
                ]);

                const health = await healthResponse.json();
                const voice = await voiceResponse.json();
                const telegram = await telegramResponse.json();

                const statusContainer = document.getElementById('service-status');
                statusContainer.innerHTML = `
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="flex items-center mb-2">
                            <span class="status-indicator ${health.success ? 'status-online' : 'status-offline'}"></span>
                            <span class="font-medium">Flask App</span>
                        </div>
                        <p class="text-sm text-gray-600">${health.success ? 'Running' : 'Error'}</p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="flex items-center mb-2">
                            <span class="status-indicator ${voice.twilio_configured ? 'status-online' : 'status-offline'}"></span>
                            <span class="font-medium">Twilio</span>
                        </div>
                        <p class="text-sm text-gray-600">${voice.twilio_configured ? 'Configured' : 'Not Configured'}</p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="flex items-center mb-2">
                            <span class="status-indicator ${voice.elevenlabs_configured ? 'status-online' : 'status-offline'}"></span>
                            <span class="font-medium">ElevenLabs</span>
                        </div>
                        <p class="text-sm text-gray-600">${voice.elevenlabs_configured ? 'Configured' : 'Not Configured'}</p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="flex items-center mb-2">
                            <span class="status-indicator ${telegram.bot_configured ? 'status-online' : 'status-offline'}"></span>
                            <span class="font-medium">Telegram</span>
                        </div>
                        <p class="text-sm text-gray-600">${telegram.bot_configured ? 'Bot Ready' : 'Not Configured'}</p>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading service status:', error);
            }
        }

        // Active Calls Monitoring
        function startActiveCallsMonitoring() {
            loadActiveCalls();
            activeCallsInterval = setInterval(loadActiveCalls, 3000); // Refresh every 3 seconds
        }

        async function loadActiveCalls() {
            try {
                const response = await fetch('/voice/control/active_calls');
                const data = await response.json();

                const activeCallsContainer = document.getElementById('active-calls');

                if (data.success && data.active_calls && data.active_calls.length > 0) {
                    activeCallsContainer.innerHTML = data.active_calls.map(call => `
                        <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center">
                                    <span class="status-indicator status-online pulse-animation"></span>
                                    <span class="font-medium">Active Call</span>
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="terminateCall('${call.call_sid}')" class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">
                                        üõë Terminate
                                    </button>
                                    <button onclick="transferCall('${call.call_sid}')" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">
                                        üìû Transfer
                                    </button>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <p><strong>Call SID:</strong> ${call.call_sid}</p>
                                    <p><strong>Status:</strong> ${call.status}</p>
                                    <p><strong>Duration:</strong> ${call.duration || 'N/A'}s</p>
                                </div>
                                <div>
                                    <p><strong>OTP Code:</strong> ${call.otp_code || 'N/A'}</p>
                                    <p><strong>User Response:</strong> ${call.user_response || 'Waiting...'}</p>
                                    <p><strong>Script:</strong> ${call.script_name || 'N/A'}</p>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    activeCallsContainer.innerHTML = `
                        <div class="text-center text-gray-500 py-8">
                            <div class="text-4xl mb-2">üìû</div>
                            <p>No active calls</p>
                            <p class="text-sm">Active calls will appear here in real-time</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading active calls:', error);
            }
        }

        async function terminateCall(callSid) {
            try {
                const response = await fetch(`/voice/control/terminate/${callSid}`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Refresh active calls immediately
                    loadActiveCalls();
                } else {
                    alert('Error terminating call: ' + result.error);
                }
            } catch (error) {
                console.error('Error terminating call:', error);
                alert('Network error occurred');
            }
        }

        async function transferCall(callSid) {
            const transferTo = prompt('Enter phone number to transfer to:');
            if (!transferTo) return;

            try {
                const response = await fetch(`/voice/control/transfer/${callSid}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        transfer_to: transferTo
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`Call transferred to ${transferTo}`);
                    loadActiveCalls();
                } else {
                    alert('Error transferring call: ' + result.error);
                }
            } catch (error) {
                console.error('Error transferring call:', error);
                alert('Network error occurred');
            }
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (activeCallsInterval) {
                clearInterval(activeCallsInterval);
            }
        });
    </script>
</body>
</html>